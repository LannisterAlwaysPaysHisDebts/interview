# 网关
## 网关的作用？
网关是上承后端服务下接前端用户的咽喉之地、关隘要道，是所有客户端请求响应出入流量的必经之路。
- 最基础也是最重要的功能：反向代理；
- 负载均衡：轮询、随机还是hash？
- 认证授权：抽离出认证授权功能，让单个服务更加专注于业务开发；有的微服务架构所有机器都部署在一个内网里，服务调用都是内网调用，对外仅仅开放网关服务器的对应端口，安全性保障；
- 动态路由：通过一个统一的主域名进行访问，然后根据子路径标识划分对应后面的微服务；这样路由策略也可能会随着业务的变化，需要实时调整。在这个过程中，不能重启服务进程，解法是通过网关动态解析；
- 灰度发布：对流量进行分流（分流策略），部分流量走到新功能里面；
- 蓝绿发布：线上 APP 版本是 V1.1.1 服务，新版本 V1.1.2 部署后，假如将所有用户一次性全切到新版本上，是否可行？如果发现问题，是否可以第一时间切回到原来的旧版本？ 
- 滚动发布：能否实现自动滚动发布，即自动下线 1 台，更新 1 台，验证 1 台，上线 1 台…… 依次将 5 台机器按批次全部自动化发布，或者全面应用虚拟化、容器化，通过 Kubernetes 的管理技术来解决滚动发布？
- 服务编排：最好能有个管理后台，可以以可视化的方式自由编排所需 API 功能；
- 限流：可以考虑当 CPU 或内存资源达到 80% 指标，连续超负荷时、服务故障时、网络延迟高等状态不健康或超过阈值时，自动保护上游后端服务，触发限流限频或熔断机制，并即时报警，避免整个服务链条发生雪崩；
- 服务降级：用户页面有时无法正确加载，可能是某些服务接口响应过慢或出现错误导致。这种现象在记录错误的同时，可以考虑返回一些提前准备好的数据或友好信息;
- 监控报警：错误状态码在连续 1 分钟内超过 50 次，10 分钟内出入流量超过警戒阈值、CPU / 内存等度量指标不正常时，是否可以向我们报警，将消息实时推送到微信、钉钉或短信
- 安全防御：对于爬虫，如何才能自动识别异常行为和数据？是否可以通过 WAF 防火墙等方案进行非人工、全自动防御和禁止？


## grpc gateway; 以及对请求的强类型化.
## 什么是正向代理，反向代理? 
- 正向代理：代理用户端请求服务端，相对于服务器用户端是匿名的. 比如VPN;
- 反向代理：代理服务端提供服务，相对于用户服务端是匿名的. 比如同一个接口,后面可能有很多个服务器提供支持;

反向代理优点:
- 让IO和服务器分离，突破IO性能，提高服务器吞吐能力。
- 控制流量分发，管理服务集群，起到负载均衡作用。
- 安全性和匿名性：通过拦截前端服务器的请求，反向代理服务器可以保护其身份，并可以抵御安全攻击。它还确保可以从单个记录定位器或 URL 访问多个服务器，而不管服务端网络的结构如何。

## 你知道哪些负载均衡算法？
- 轮询算法：将多个用户请求按顺序依次分发到机器上，让每台机器承受相同的压力;
- 加权轮询算法：设置不同机器的权重不同; 能者多劳;
- 随机算法：和轮询类似，让所有请求随机分配到不同的机器上，请求越多最后分散在每台机器上的请求数约接近相等;
- 加权随机算法：和加权轮询算法道理相似;
- 最小连接数算法：先看谁当前处理的链接数最少那就把活分给谁，最后的分工也相对公平;

- Hash算法：hash用户标示(ip、id)后对服务器数量取模; 解决用户多次请求走到不同服务器的问题;

- 一致性Hash：解决上面N变动产生的问题;
    - 创建hash环(对`2^32`取模)
    - 将服务器(ip、编号)hash确定在hash环上的位置,将数据Key使用相同的函数Hash计算出哈希值，并确定此数据在环上的位置，从此位置沿环顺时针查找，遇到的服务器就是其应该定位到的服务器;
    - 如果某台服务器挂了,代码只会继续沿着环顺时针寻找,定位到另一台server;
    - 服务节点太少的情况下，容易因为节点分布不均匀面造成数据倾斜（被缓存的对象大部分缓存在某一台服务器上）问题; 一致性Hash算法引入了虚拟节点机制，即对每一个服务器节点计算多个哈希，每个计算结果位置都放置一个此服务节点，称为虚拟节点。

常用的负载均衡框架: nginx、LVS、HAProxy、F5(硬件负载均衡,很贵)
